<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>JSONPullParser demo</title>
    <script src="https://unpkg.com/json-pull-parser/dist/json-pull-parser.js"></script>
  </head>
  <body>
    <p><strong>JSONPullParser demo:</strong> <a href="http://www.susi.se/json-pull-parser/">Project page</a></p>
    <svg version="1.1"
         baseProfile="full"
         width="200"
         height="130"
         viewBox="0 0 200 130"
         xmlns="http://www.w3.org/2000/svg">
      <path d="M89,9 h4 l4,-4 l-4,4 h4 l4,-4 l-4,4 h4 l4,-4 l-4,4 h4 l4,-4 l-4,4 h4" stroke="black"/>
      <path d="M99,9 L100,10 L101,9 z" stroke="black" fill="black"/>
      <line x1="100" y1="10" x2="100" y2="100" stroke="black" fill="black"/>
      <circle cx="100" cy="110" r="10" stroke="none" fill="black"/>
    </svg>
    <br>
    <button onclick="parseJSON()">JSON.parse</button>
    <button onclick="parseJSONPullParser()">JSONPullParser.parse</button>
    <button onclick="bench()">Reset</button>
    <pre>
      Please wait, benchmarking!
    </pre>
    <script>
      let thetaD1 = 0;
      let theta = 110 * Math.PI * 2 / 360;

      let mark;

      /**
       * @param {Integer} timestamp
       * @returns {void}
       */
      function draw (timestamp) {
        let steps = 1;
        if (!mark) mark = timestamp;
        else if (timestamp - mark >= 17) {
          steps = Math.floor((timestamp - mark) / (1000 / 60));
        }
        mark = timestamp;

        const start = Date.now();
        for (let i = 0; i < steps; ++i) {
          const thetaD2 = 9.81 * Math.sin(theta) / 90;
          thetaD1 += thetaD2 * 0.2;
          theta += thetaD1 * 0.2;
        }

        const x = 100 + 90 * Math.sin(theta);
        const y = 10 - 90 * Math.cos(theta);

        const circle = document.querySelector('circle');
        circle.setAttribute('cx', x);
        circle.setAttribute('cy', y);

        const line = document.querySelector('line');
        line.setAttribute('x2', x);
        line.setAttribute('y2', y);

        while (Date.now() - start < 15 && tasks.length > 0) {
          if (tasks[0].next().done) tasks.shift();
        }

        requestAnimationFrame(draw);
      }

      let json = '';

      requestAnimationFrame(draw);

      /**
       * @returns {void}
       */
      function bench () {
        let data = [];
        for (let i = 0; i < 1e6; ++i) data.push(Math.random() * 1e16);
        json = JSON.stringify(data);
        let t1 = Date.now();
        let o1 = JSON.parse(json);
        t1 = Date.now() - t1;

        while (t1 < 500 && json.length < 100e6) {
          data = [...data, ...data];
          json = JSON.stringify(data);
          t1 = Date.now();
          o1 = JSON.parse(json);
          t1 = Date.now() - t1;
        }

        let t2 = Date.now();
        const o2 = JSONPullParser.parse(json);
        t2 = Date.now() - t2;

        const same = JSON.stringify(o1) === JSON.stringify(o2);
        const log = document.querySelector('pre');
        log.textContent = 'json.length:          ' +
          (json.length / 1e6).toFixed(2) + 'mb' + '\n' +
          'JSON.parse:           ' + t1 + 'ms' + '\n' +
          'JSONPullParser.parse: ' + t2 + 'ms' + '\n' +
          'Equality:             ' + same + '\n';
      }

      setTimeout(bench, 1);

      /* eslint-disable no-unused-vars -- Apparently a HTML parser bug */
      /**
      * @returns {void}
      */
      function parseJSON () {
        setTimeout(function () {
          const parseStartTime = Date.now();
          JSON.parse(json);
          const log = document.querySelector('pre');
          log.textContent += 'JSON.parse done in ' +
            (Date.now() - parseStartTime) + 'ms\n';
        }, 0);
      }

      const tasks = [];
      // let id = 0;

      /**
      * @returns {void}
      */
      function parseJSONPullParser () {
        /* eslint-enable no-unused-vars -- Apparently a HTML parser bug */
        // const gid = ++id;
        const builder = new JSONPullParser.ObjectBuilder();
        const parser = new JSONPullParser(json);
        const tokens = parser.tokens();
        let fragments = 0;
        let parseStartTime = 0;
        let count = 0;

        tasks.push({
          next () {
            if (fragments === 0) parseStartTime = Date.now();
            ++fragments;
            // const fragmentStartTime = Date.now();

            for (let i = 0; i < 1e3; ++i) {
              const token = tokens.next();
              if (token.done) {
                const log = document.querySelector('pre');
                log.textContent += 'JSONPullParser parsed ' +
                  (count / 1e6).toFixed(0) + 'M tokens in ' +
                  (Date.now() - parseStartTime) + 'ms using ' +
                  fragments + ' fragments\n';
                return {done: true};
              }
              builder.handle(token);
              ++count;
            }
            return {done: false};
          }
        });
      }
    </script>
  </body>
</html>
